name: Deploy to Hugging Face Spaces

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰
    paths:
      - 'spaces/**'  # spaces/ ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹œë§Œ ì‹¤í–‰
      - 'gradio_app.py'
      - '.github/workflows/deploy-spaces.yml'
  
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install huggingface_hub
      
      - name: Deploy to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE: ${{ secrets.HF_SPACE }}  # ì˜ˆ: username/etf-rag-agent
        run: |
          python - <<EOF
          import os
          from huggingface_hub import HfApi, create_repo
          
          token = os.getenv("HF_TOKEN")
          space_id = os.getenv("HF_SPACE")
          
          if not token or not space_id:
              print("âŒ HF_TOKEN ë˜ëŠ” HF_SPACE í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
              exit(1)
          
          api = HfApi(token=token)
          
          # Spaceê°€ ì—†ìœ¼ë©´ ìƒì„±
          try:
              create_repo(
                  repo_id=space_id,
                  token=token,
                  repo_type="space",
                  space_sdk="gradio",
                  exist_ok=True
              )
              print(f"âœ… Space '{space_id}' ì¤€ë¹„ ì™„ë£Œ")
          except Exception as e:
              print(f"âš ï¸ Space ìƒì„± ì¤‘ ì˜¤ë¥˜ (ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ): {e}")
          
          # íŒŒì¼ ì—…ë¡œë“œ
          files_to_upload = [
              ("spaces/app.py", "app.py"),
              ("spaces/README.md", "README.md"),
              ("spaces/requirements.txt", "requirements.txt"),
          ]
          
          for local_path, remote_path in files_to_upload:
              try:
                  api.upload_file(
                      path_or_fileobj=local_path,
                      path_in_repo=remote_path,
                      repo_id=space_id,
                      repo_type="space",
                      token=token
                  )
                  print(f"âœ… ì—…ë¡œë“œ ì™„ë£Œ: {remote_path}")
              except Exception as e:
                  print(f"âŒ ì—…ë¡œë“œ ì‹¤íŒ¨ ({remote_path}): {e}")
                  exit(1)
          
          print(f"\nğŸ‰ ë°°í¬ ì™„ë£Œ!")
          print(f"ğŸ”— Space URL: https://huggingface.co/spaces/{space_id}")
          EOF
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "## ğŸ‰ ë°°í¬ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Hugging Face Spaceì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **Space URL**: https://huggingface.co/spaces/${{ secrets.HF_SPACE }}" >> $GITHUB_STEP_SUMMARY
